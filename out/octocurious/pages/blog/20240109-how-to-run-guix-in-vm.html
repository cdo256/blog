<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="English" xml:lang="English">
<head>
<!-- 2024-01-18 Thu 14:59 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>How to Share =/gnu/store= between a Host and a Guest Guix System</title>
<meta name="author" content="Christina O'Donnell" />
<meta name="generator" content="Org Mode" />
<link rel="icon" type="image/x-icon" href="/include/octocurious-3-favicon-512.ico" />
<link rel="stylesheet" href="/include/simple.css" />
<link rel="stylesheet" href="/include/style.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
</head>
<body>
<header id="header" class="status">
<script async src="https://www.googletagmanager.com/gtag/js?id=AW-11397193092"></script>
<script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());
 gtag('config', 'AW-11397193092');
</script>
<span class="site-title">
    <img class="logo" src="/include/octocurious-3-tight-nobg.svg">
    <div class="text">
        <h1>Octocurious</h1>
        <h2>Christina O'Donnell</h2>
    </div>
</span>
<nav>
    <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/pages/blog.html">Blog</a></li>
        <li><a href="/pages/tutoring.html">Tutoring</a></li>
        <!-- <li><a href="/resume.html">Resume</a></li> -->
        <li><a href="https://github.com/cdo256">GitHub</a></li>
    </ul>
</nav>
</header>
<main id="content" class="content">
<h1 class="title">How to Share <code>/gnu/store</code> between a Host and a Guest Guix System</h1>

<div id="outline-container-org213e2c4" class="outline-2">
<h2 id="org213e2c4">Introduction</h2>
<div class="outline-text-2" id="text-org213e2c4">
<p>
If you've ever tried out <a href="https://guix.gnu.org/manual/en/guix.html#Invoking-guix-system"><code>guix system vm</code></a>, you've probably found that running
<a href="https://guix.gnu.org/manual/en/html_node/Invoking-guix_002ddaemon.html">Guix</a> commands in the guest system simply don't work.
</p>

<pre class="example">
root@test-vm# guix build hello
guix build: error: opening lock file /gnu/store/...-mirrors.lock: Read-only file system
</pre>


<p>
These do, however, work using <code>guix system image</code>, which is a much heavier,
fully independent VM image. However, these are a lot slower, requiring every
package to be built from scratch. Doing any Guix command requires downloading
and rebuilding many <i>many</i> packages that you already have on your host machine.
</p>

<p>
One approach to avoid this could be to reuse your existing Guix daemon process.
This way, you only build what you don't already have in your main system, saving
a <i>lot</i> of time.
</p>

<p>
This post explains how you can share <code>/gnu/store/</code> with a guest Guix System VM
instance. The approach was <a href="https://issues.guix.gnu.org/39815">suggested by Ludovic Court√®s</a> in 2020. It assumes that
you are running Guix System, but can be followed if you have Guix installed on
any machine.
</p>

<p>
This method works by connecting the guest Guix commands to the hosts Guix daemon
through TCP. This is possible through making just two changes:
</p>
<ol class="org-ol">
<li>Allow Guix daemon to accept connections through TCP using <code>--listen</code>.</li>
<li>Set the <code>GUIX_DAEMON_SOCKET</code> environment variable inside the guest to
connect to this socket.</li>
</ol>
</div>
</div>

<div id="outline-container-org6aabbef" class="outline-2">
<h2 id="org6aabbef">Make <code>guix-daemon</code> listen over TCP</h2>
<div class="outline-text-2" id="text-org6aabbef">
<p>
The first step is to change your Guix daemon to accept connections over TCP. To
do this you need to pass in the <code>--listen</code> parameter to Guix daemon.
</p>

<p>
To add parameters to Guix daemon on your host Guix System, you need to edit your
services to add the <code>--listen</code> parameter to the guix-service-type, like so:
</p>

<div class="org-src-container">
<pre class="src src-Scheme">(operating-system
  ...
  (services
    (cons* ...
           (modify-services %desktop-services
             ...
             (guix-service-type config =&gt;
                                (guix-configuration
                                  (inherit config)
                                  (extra-options '("--listen=localhost:44146"
                                                   "--listen=/var/guix/daemon-socket/socket")))))))
</pre>
</div>

<p>
Port 44146 is the default for Guix protocol, and
<code>/var/guix/daemon-socket/socket</code> is the default UNIX socket location.
</p>

<p>
Here we're using <a href="https://guix.gnu.org/manual/en/html_node/Service-Reference.html"><code>modify-services</code></a>, which goes through all of the %desktop
services and makes a specified change. If you don't have a modify-services
already, then you'll need to create one if you're current services depends on
<code>%desktop-services</code> or <code>%base-services</code> or similar, having the modify-services
expression go in the place <code>%desktop-services</code> used to go.
</p>

<p>
If you already have a <code>guix-service-type</code> rule, then you'd want to simply add
the <code>(extra-options ...)</code> to that existing rule. Otherwise, you can use the
format above as-is.
</p>

<p>
For reference, here's links to where you can find the documentation for:
<a href="https://guix.gnu.org/manual/en/html_node/System-Configuration.html">Guix System</a>, <a href="https://guix.gnu.org/manual/en/html_node/Service-Reference.html"><code>modify-services</code></a>, <a href="https://guix.gnu.org/manual/en/html_node/Base-Services.html"><code>guix-service-type</code></a>, and <a href="https://guix.gnu.org/manual/en/html_node/Invoking-guix_002ddaemon.html"><code>--listen</code></a>.
</p>

<p>
If you're running Guix on a foreign distro, then you can edit the init script.
As an example, if you run a 'normal' distro that runs <a href="https://systemd.io/">Systemd</a>, then you'd add
the <code>--listen</code> flags to the <a href="https://www.freedesktop.org/software/systemd/man/latest/systemd.service.html"><code>ExecStart</code></a> line, like so:
</p>

<div class="org-src-container">
<pre class="src src-Systemd"># /etc/systemd/system/guix-daemon.service
# This is a "service unit file" for the systemd init system to launch
# 'guix-daemon'.  Drop it in /etc/systemd/system or similar to have
# 'guix-daemon' automatically started.

[Unit]
Description=Build daemon for GNU Guix

[Service]
ExecStart=/usr/bin/guix-daemon --build-users-group=_guixbuild --listen=localhost:44146 --listen=/var/guix/daemon-socket/socket
Environment='GUIX_LOCPATH=/var/guix/profiles/per-user/root/guix-profile/lib/locale' LC_ALL=en_GB.utf8
RemainAfterExit=yes

# See &lt;https://lists.gnu.org/archive/html/guix-devel/2016-04/msg00608.html&gt;.
# Some package builds (for example, go@1.8.1) may require even more than
# 1024 tasks.
TasksMax=8192

[Install]
WantedBy=multi-user.target
</pre>
</div>
</div>
</div>

<div id="outline-container-org01c9e03" class="outline-2">
<h2 id="org01c9e03">Declaring the guest system</h2>
<div class="outline-text-2" id="text-org01c9e03">
<p>
Next we want a Guix System declaration that we can use to boot up a VM with.
This guide should work regardless of what you use for this. For this tutorial
we'll use a rather minimal VM definition, useful for singling out errors.
</p>

<p>
Save the following as <code>test-vm.scm</code>. Include any packages or services that you desire.
</p>

<div class="org-src-container">
<pre class="src src-Scheme">;; ~/test-vm.src
(use-modules (gnu))
(use-service-modules networking)
(use-package-modules bootloaders)

(define %keyboard-layout
  (keyboard-layout "gb"))

(operating-system
  (locale "en_GB.utf8")
  (timezone "Etc/UTC")
  (keyboard-layout %keyboard-layout)
  (host-name "test-vm")
  (packages (cons* (specification-&gt;package "net-tools")
                   %base-packages))
  (services
  (cons* (service dhcp-client-service-type)
          %base-services))
  (bootloader
  (bootloader-configuration
    (bootloader grub-bootloader)
    (targets '("/dev/vda"))
    (terminal-outputs '(console))
    (keyboard-layout %keyboard-layout)))
  (file-systems
  (cons* (file-system
          (mount-point "/")
          (device "/dev/vda1")
          (type "ext4"))
          %base-file-systems)))
</pre>
</div>

<p>
Now it's time to build the VM. The following builds the VM image and starts it
up in one command.
</p>

<div class="org-src-container">
<pre class="src src-Shell">sudo $(guix system vm test-vm.scm) -nic user,model=virtio-net-pci --enable-kvm
</pre>
</div>

<p>
This runs a script that wraps a call to <code>qemu-*</code> so the options after the <code>$()</code>
are interpreted by QEMU (typically <code>qemu-x86_64</code>), so you can consult <a href="https://www.qemu.org/docs/master/system/qemu-manpage.html">their
documentation</a> for more.<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>
</p>
</div>
</div>

<div id="outline-container-org860b35b" class="outline-2">
<h2 id="org860b35b">Connecting to the Guix daemon from inside the guest</h2>
<div class="outline-text-2" id="text-org860b35b">
<p>
If that succeeds then we're inside the VM. You can login as root without a
password. Here we can use the default host gateway IP, which is typically
10.0.2.2. This address from the guest corresponds to the host's local IP. So
writing the following ensure Guix connects to your machine's Guix daemon.
</p>

<pre class="example">
# export GUIX_DAEMON_SOCKET=guix://10.0.2.2:44146
</pre>


<p>
If this works then you should be able to run any Guix command successfully. As
mentioned before, 44146 is the default port of the Guix protocol.
</p>

<pre class="example">
# guix build hello
/gnu/store/6fbh8phmp3izay6c0dpggpxhcjn4xlm5-hello-2.12.1
</pre>
</div>
</div>

<div id="outline-container-orge9661d7" class="outline-2">
<h2 id="orge9661d7">Conclusion</h2>
<div class="outline-text-2" id="text-orge9661d7">
<p>
This setup streamlines development and testing workflows, making it a valuable
tool for Guix users. Stay updated with Guix's evolving ecosystem to make the
most of this powerful package manager.
</p>

<p>
In this guide, you've learned how to efficiently share the <code>/gnu/store</code>
directory between a host and guest Guix System, saving time and compute. By
configuring the Guix daemon to listen over TCP, you can seamlessly steal
packages from the host without anyone noticing they're missing!
</p>

<p>
If you encounter issues or have suggestions for improvements, please reach out
at <a href="mailto:cdo@mutix.org">cdo@mutix.org</a>.
</p>

<p>
Happy hacking!
</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
If you get an error like <code>/dev/kvm is not found</code>, then it means that
virtualization isn't enabled in hardware. If you get an error saying that
<code>qemu-kvm is missing</code>, then it's to do with hardware virtualization, not a
missing package, as qemu-kvm is always installed with <code>qemu</code> on Guix. Instead it
means that you'll need to reboot into BIOS settings and enable 'vmx' or 'svm'
under the CPU menu. Alternatively, you can remove the <code>--enable-kvm</code> altogether.
</p></div></div>


</div>
</div></main>
<footer id="footer" class="status">
<span>Copyright &copy; Christina O'Donnell 2023</span>
</footer>
</body>
</html>